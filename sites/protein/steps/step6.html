<h2>CÂN BẰNG HỆ THỐNG</h2>
<p>Sau khi tối ưu năng lượng, ta có được cấu trúc ban đầu hợp lý về hình học và định hướng dung môi. Tuy nhiên, trước khi mô phỏng động lực học phân tử (MD) thực sự, cần phải cân bằng dung môi và ion xung quanh protein. Nếu bỏ qua bước này và chạy ngay MD không hạn chế, hệ thống có thể sụp đổ vì dung môi mới chỉ tối ưu nội tại, chưa thích ứng với phân tử hòa tan, dẫn đến kết quả sai hoặc lỗi mô phỏng.</p>

<p>Trong giai đoạn cân bằng, hệ thống được đưa về nhiệt độ mô phỏng mong muốn, sau đó ổn định áp suất để đạt mật độ phù hợp. File <code>posre.itp</code> (tạo bởi <code>pdb2gmx</code>) sẽ được dùng để áp đặt lực hạn chế lên các nguyên tử nặng của protein, giúp dung môi thích nghi trong khi giữ cấu trúc protein ổn định. Vị trí ràng buộc được cung cấp từ file tọa độ đi kèm tùy chọn <code>-r</code> khi chạy <code>grompp</code>.</p>

<h3>Cân bằng đẳng tích (NVT)</h3>
<p>Giai đoạn đầu tiên giữ cố định số hạt, thể tích và nhiệt độ. Trong khoảng 50-100 ps (ở đây chọn 100 ps), nhiệt độ hệ thống sẽ ổn định ở giá trị mong muốn (298 K). Trên CPU đa nhân có thể mất ~1 giờ, còn GPU chỉ 1-2 phút.</p>
<div class="code">
gmx grompp -f inputs/nvt.mdp -c em.gro -r em.gro -p topol.top -o nvt.tpr<br>
gmx mdrun -deffnm nvt
</div>
<p>Một số thiết lập trong <code>nvt.mdp</code>:<br>
- <code>gen_vel = yes</code>: sinh vận tốc ngẫu nhiên ban đầu (có thể đổi <code>gen_seed</code> để tạo nhiều mô phỏng).<br>
- <code>tcoupl = V-rescale</code>: thermostat V-rescale.<br>
- <code>pcoupl = no</code>: chưa điều chỉnh áp suất.</p>
<p>Kiểm tra tiến triển nhiệt độ bằng:</p>
<div class="code">
gmx energy -f nvt.edr -o temperature.xvg
</div>
<ul>
  <li>Nhập <code>17</code> → Enter (chọn Temperature).</li>
  <li>Nhập <code>0</code> → Enter (kết thúc).</li>
</ul>
<p>Kết quả mong đợi: nhiệt độ đạt 298 K và ổn định trong suốt quá trình.</p>

<h3>Cân bằng đẳng áp (NPT)</h3>
<p>Sau NVT, hệ thống đã ổn định về nhiệt độ. Tiếp theo, cần ổn định áp suất và mật độ trong tập hợp NPT (giữ N, P, T không đổi), gần giống với điều kiện thí nghiệm thực tế. File tham số <code>npt.mdp</code> có thêm phần điều chỉnh áp suất (C-rescale barostat) và thường cần thời gian dài hơn để hội tụ.</p>
<p>Một số thiết lập trong <code>npt.mdp</code>:<br>
- <code>continuation = yes</code>: tiếp tục từ NVT.<br>
- <code>gen_vel = no</code>: dùng vận tốc từ NVT.</p>
<div class="code">
gmx grompp -f inputs/npt.mdp -c nvt.gro -r nvt.gro -t nvt.cpt -p topol.top -o npt.tpr<br>
gmx mdrun -deffnm npt
</div>

<h3>Phân tích kết quả</h3>
<p><b>Kiểm tra áp suất của hệ bằng lệnh sau:</b></p>
<div class="code">
gmx energy -f npt.edr -o pressure.xvg
</div>
<ul>
  <li>Nhập <code>17</code> → Enter (chọn Pressure).</li>
  <li>Nhập <code>0</code> → Enter (kết thúc).</li>
</ul>

<p>Áp suất dao động mạnh (~100 ps đầu), nhưng giá trị trung bình (ví dụ -3 ± 11 bar so với 1 bar chuẩn) vẫn chấp nhận được về mặt thống kê.</p>

<p><b>Kiểm tra mật độ của hệ bằng lệnh sau:</b></p>
<div class="code">
gmx energy -f npt.edr -o density.xvg
</div>
<ul>
  <li>Nhập <code>23</code> → Enter (chọn Density).</li>
  <li>Nhập <code>0</code> → Enter (kết thúc).</li>
</ul>

<p>Giá trị trung bình trong 500 ps có thể quanh 1025 kg/m³, cao hơn thực nghiệm do có thêm protein và ion. Quan trọng là mật độ đã ổn định.</p>

<p><i>Lưu ý:</i> Kết quả chi tiết có thể khác nhau giữa các mô phỏng do tính ngẫu nhiên và thời gian hội tụ, vì vậy không cần khớp hoàn toàn với ví dụ.</p>
